<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HR Platform v2.0</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans">
    <div id="app" class="min-h-screen flex flex-col">
        
        <!-- ========== –≠–ö–†–ê–ù –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò ========== -->
        <div v-if="!isAuthenticated" class="fixed inset-0 bg-gradient-to-br from-blue-900 to-blue-700 flex justify-center items-center z-50">
            <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md mx-4">
                <div class="text-center mb-6">
                    <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-blue-700 rounded-2xl flex items-center justify-center text-white text-2xl font-bold mx-auto shadow-lg mb-3">HR</div>
                    <h1 class="text-2xl font-bold text-gray-800">HR Platform</h1>
                    <p class="text-gray-500 text-sm">{{ authMode === 'login' ? '–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É' : '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫–æ–º–ø–∞–Ω–∏–∏' }}</p>
                </div>
                <div v-if="authError" class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-4 text-sm">{{ authError }}</div>
                
                <div v-if="authMode === 'login'" class="space-y-4">
                    <input v-model="authForm.email" type="email" class="w-full px-4 py-3 border rounded-lg outline-none" placeholder="Email">
                    <input v-model="authForm.password" type="password" class="w-full px-4 py-3 border rounded-lg outline-none" placeholder="–ü–∞—Ä–æ–ª—å" @keyup.enter="login">
                    <button @click="login" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 font-medium">–í–æ–π—Ç–∏</button>
                    <p class="text-center text-sm text-gray-500">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a @click="authMode = 'register'" class="text-blue-600 hover:underline cursor-pointer">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a></p>
                </div>

                <div v-if="authMode === 'register'" class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <input v-model="authForm.first_name" type="text" class="w-full px-4 py-3 border rounded-lg outline-none" placeholder="–ò–º—è">
                        <input v-model="authForm.last_name" type="text" class="w-full px-4 py-3 border rounded-lg outline-none" placeholder="–§–∞–º–∏–ª–∏—è">
                    </div>
                    <input v-model="authForm.company_name" type="text" class="w-full px-4 py-3 border rounded-lg outline-none" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏">
                    <input v-model="authForm.email" type="email" class="w-full px-4 py-3 border rounded-lg outline-none" placeholder="Email">
                    <input v-model="authForm.password" type="password" class="w-full px-4 py-3 border rounded-lg outline-none" placeholder="–ü–∞—Ä–æ–ª—å">
                    <button @click="register" class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 font-medium">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
                    <p class="text-center text-sm text-gray-500">–ï—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <a @click="authMode = 'login'" class="text-blue-600 hover:underline cursor-pointer">–í–æ–π—Ç–∏</a></p>
                </div>
            </div>
        </div>

        <!-- ========== –û–°–ù–û–í–ù–û–ô –ò–ù–¢–ï–†–§–ï–ô–° ========== -->
        <div v-else class="flex flex-col min-h-screen">
            <header class="bg-white shadow-sm sticky top-0 z-40">
                <div class="border-b">
                    <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-700 rounded-lg flex items-center justify-center text-white font-bold shadow-lg">HR</div>
                            <div>
                                <h1 class="text-xl font-bold text-gray-800 leading-tight">HR Platform</h1>
                                <p class="text-xs text-gray-500">{{ companyProfile.name || currentUser?.company_name }}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-4">
                            <!-- –ö–õ–ò–ö–ê–ë–ï–õ–¨–ù–´–ô –ü–†–û–§–ò–õ–¨ -->
                            <div @click="currentTab = 'settings'; loadSettings()" class="flex items-center gap-2 px-3 py-2 bg-gray-50 rounded-lg border cursor-pointer hover:bg-gray-100 transition">
                                <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 font-bold">{{ currentUser?.first_name[0] }}</div>
                                <div class="text-sm hidden md:block">
                                    <div class="font-medium text-gray-700">{{ currentUser?.first_name }} {{ currentUser?.last_name }}</div>
                                    <div class="text-xs text-gray-500">{{ currentUser?.role }}</div>
                                </div>
                            </div>
                            <button @click="logout" class="text-gray-400 hover:text-red-500 transition"><i class="fas fa-sign-out-alt text-xl"></i></button>
                        </div>
                    </div>
                </div>
                <div class="max-w-7xl mx-auto px-4 overflow-x-auto">
                    <nav class="flex gap-6">
                        <button @click="currentTab = 'dashboard'; loadDashboard()" :class="['py-3 text-sm font-medium border-b-2 transition-colors', currentTab === 'dashboard' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700']">–î–∞—à–±–æ—Ä–¥</button>
                        <button @click="currentTab = 'vacancies'; fetchData()" :class="['py-3 text-sm font-medium border-b-2 transition-colors', currentTab === 'vacancies' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700']">–í–∞–∫–∞–Ω—Å–∏–∏</button>
                        <button @click="currentTab = 'candidates'; loadCandidates()" :class="['py-3 text-sm font-medium border-b-2 transition-colors', currentTab === 'candidates' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700']">–ö–∞–Ω–¥–∏–¥–∞—Ç—ã</button>
                        <!-- –í–ï–†–ù–£–õ–ò –ö–ù–û–ü–ö–£ –ù–ê–°–¢–†–û–ï–ö -->
                        <button @click="currentTab = 'settings'; loadSettings()" :class="['py-3 text-sm font-medium border-b-2 transition-colors', currentTab === 'settings' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700']">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
                    </nav>
                </div>
            </header>

            <main class="flex-1 max-w-7xl mx-auto px-4 py-6 w-full">
                
                <!-- 1. –î–ê–®–ë–û–†–î -->
                <div v-if="currentTab === 'dashboard'" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-l-4 border-l-blue-500">
                            <div class="text-gray-500 text-xs font-bold uppercase mb-1">–ê–∫—Ç–∏–≤–Ω—ã–µ –≤–∞–∫–∞–Ω—Å–∏–∏</div>
                            <div class="text-3xl font-bold text-gray-800">{{ dashboardData.active_vacancies }}</div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-l-4 border-l-yellow-500">
                            <div class="text-gray-500 text-xs font-bold uppercase mb-1">–í —Ä–∞–±–æ—Ç–µ</div>
                            <div class="text-3xl font-bold text-gray-800">{{ dashboardData.candidates_in_work }}</div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-l-4 border-l-green-500">
                            <div class="text-gray-500 text-xs font-bold uppercase mb-1">–ù–∞–Ω—è—Ç–æ –∑–∞ –º–µ—Å—è—Ü</div>
                            <div class="text-3xl font-bold text-gray-800">{{ dashboardData.hired_this_month }}</div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-l-4 border-l-purple-500">
                            <div class="text-gray-500 text-xs font-bold uppercase mb-1">–ö–æ–Ω–≤–µ—Ä—Å–∏—è</div>
                            <div class="text-3xl font-bold text-gray-800">{{ dashboardData.conversion_rate }}%</div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="bg-white p-6 rounded-xl shadow-sm border lg:col-span-2">
                            <h3 class="font-bold text-gray-800 mb-4">üìä –í–æ—Ä–æ–Ω–∫–∞ –ø–æ–¥–±–æ—Ä–∞</h3>
                            <div class="h-64"><canvas id="dashboardChart"></canvas></div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border">
                            <h3 class="font-bold text-gray-800 mb-4">üî• –¢—Ä–µ–±—É—é—Ç –≤–Ω–∏–º–∞–Ω–∏—è</h3>
                            <div v-if="dashboardData.urgent_candidates.length > 0" class="space-y-3">
                                <div v-for="u in dashboardData.urgent_candidates" :key="u.id" class="p-3 bg-red-50 rounded-lg border border-red-100 flex justify-between items-center cursor-pointer hover:bg-red-100" @click="openCandidateCard(u.id)">
                                    <div><div class="font-bold text-sm text-gray-800">{{ u.name }}</div><div class="text-xs text-gray-500">{{ u.vacancy }}</div></div>
                                    <div class="text-xs font-bold text-red-600 bg-white px-2 py-1 rounded">{{ u.days }} –¥–Ω.</div>
                                </div>
                            </div>
                            <div v-else class="text-center text-gray-400 py-10 text-sm">–ù–µ—Ç –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á üéâ</div>
                        </div>
                    </div>
                </div>

                <!-- 2. –í–ê–ö–ê–ù–°–ò–ò -->
                <div v-if="currentTab === 'vacancies'">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">–ê–∫—Ç–∏–≤–Ω—ã–µ –≤–∞–∫–∞–Ω—Å–∏–∏</h2>
                        <button @click="showModal = true" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 shadow transition flex items-center"><i class="fas fa-plus mr-2"></i> –°–æ–∑–¥–∞—Ç—å –≤–∞–∫–∞–Ω—Å–∏—é</button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div v-for="vac in vacancies" :key="vac.id" @click="openVacancy(vac.id)" class="bg-white p-5 rounded-xl shadow-sm border hover:shadow-md cursor-pointer transition group">
                            <div class="flex justify-between items-start mb-2">
                                <h3 class="font-bold text-lg text-gray-800 group-hover:text-blue-600 transition">{{ vac.title }}</h3>
                                <span class="bg-green-100 text-green-700 text-xs px-2 py-1 rounded-full font-medium">Active</span>
                            </div>
                            <p class="text-sm text-gray-500 line-clamp-2 mb-4">{{ vac.description }}</p>
                            <div class="flex justify-between items-center text-xs text-gray-400 border-t pt-3">
                                <span>ID: {{ vac.id }}</span><span>–ö–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π ‚Üí</span>
                            </div>
                        </div>
                    </div>
                    <div v-if="vacancies.length === 0" class="text-center py-20 text-gray-400">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –≤–∞–∫–∞–Ω—Å–∏–π. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é!</div>
                </div>

                <!-- 3. –ö–ê–ù–î–ò–î–ê–¢–´ -->
                <div v-if="currentTab === 'candidates'">
                    <div class="bg-white p-4 rounded-lg shadow-sm border mb-6 flex flex-wrap gap-4">
                        <div class="flex-1 min-w-[200px] relative">
                            <input v-model="filters.search" @input="debouncedSearch" type="text" placeholder="–ü–æ–∏—Å–∫..." class="w-full pl-10 pr-4 py-2 border rounded-lg outline-none">
                            <span class="absolute left-3 top-2.5 text-gray-400"><i class="fas fa-search"></i></span>
                        </div>
                        <select v-model="filters.status" @change="loadCandidates" class="border rounded-lg px-3 py-2 bg-white"><option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option><option v-for="s in statuses" :key="s.key" :value="s.key">{{ s.label }}</option></select>
                        <button @click="resetFilters" class="text-gray-500 hover:text-gray-700 px-2">–°–±—Ä–æ—Å</button>
                    </div>
                    <div class="bg-white rounded-lg shadow-sm border overflow-hidden">
                        <table class="w-full text-left border-collapse">
                            <thead class="bg-gray-50 border-b">
                                <tr><th class="px-6 py-3 text-xs font-medium text-gray-500 uppercase">–ö–∞–Ω–¥–∏–¥–∞—Ç</th><th class="px-6 py-3 text-xs font-medium text-gray-500 uppercase">–í–∞–∫–∞–Ω—Å–∏—è</th><th class="px-6 py-3 text-xs font-medium text-gray-500 uppercase text-center">Score</th><th class="px-6 py-3 text-xs font-medium text-gray-500 uppercase text-center">–°—Ç–∞—Ç—É—Å</th><th class="px-6 py-3 text-xs font-medium text-gray-500 uppercase text-right">–î–∞—Ç–∞</th></tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                <tr v-for="cand in candidatesList.items" :key="cand.id" @click="openCandidateCard(cand.id)" class="hover:bg-gray-50 cursor-pointer transition">
                                    <td class="px-6 py-4"><div class="font-medium text-gray-900">{{ cand.first_name }} {{ cand.last_name }}</div><div class="text-xs text-gray-500">{{ cand.email }}</div></td>
                                    <td class="px-6 py-4 text-sm text-gray-600">{{ cand.vacancy_title }}</td>
                                    <td class="px-6 py-4 text-center"><span class="inline-flex items-center justify-center px-2.5 py-0.5 rounded-full text-xs font-medium border" :class="getScoreBgColor(cand.ai_score)">{{ cand.ai_score }}%</span></td>
                                    <td class="px-6 py-4 text-center"><span class="px-2 py-1 text-xs rounded-full" :class="getStatusClass(cand.status)">{{ getStatusLabel(cand.status) }}</span></td>
                                    <td class="px-6 py-4 text-right text-sm text-gray-500">{{ new Date(cand.created_at).toLocaleDateString() }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 4. –ù–ê–°–¢–†–û–ô–ö–ò (–í–ï–†–ù–£–õ–ò!) -->
                <div v-if="currentTab === 'settings'" class="space-y-6">
                    <div class="bg-white rounded-lg shadow-sm border">
                        <div class="border-b px-4">
                            <nav class="flex gap-4">
                                <button @click="settingsSubTab = 'company'" :class="['py-3 text-sm font-medium border-b-2 transition', settingsSubTab === 'company' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500']">üè¢ –ö–æ–º–ø–∞–Ω–∏—è</button>
                                <button @click="settingsSubTab = 'users'; loadUsers()" :class="['py-3 text-sm font-medium border-b-2 transition', settingsSubTab === 'users' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500']">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</button>
                            </nav>
                        </div>
                        <div class="p-6">
                            <!-- –ü—Ä–æ—Ñ–∏–ª—å –∫–æ–º–ø–∞–Ω–∏–∏ -->
                            <div v-if="settingsSubTab === 'company'" class="max-w-2xl">
                                <h2 class="text-xl font-bold mb-6">–ü—Ä–æ—Ñ–∏–ª—å –∫–æ–º–ø–∞–Ω–∏–∏</h2>
                                <div class="space-y-4">
                                    <div><label class="block text-sm font-medium text-gray-700 mb-1">–ù–∞–∑–≤–∞–Ω–∏–µ</label><input v-model="companyProfile.name" type="text" class="w-full border rounded-lg px-4 py-2"></div>
                                    <div><label class="block text-sm font-medium text-gray-700 mb-1">–û–ø–∏—Å–∞–Ω–∏–µ</label><textarea v-model="companyProfile.description" rows="3" class="w-full border rounded-lg px-4 py-2"></textarea></div>
                                    <button @click="saveCompanyProfile" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                                </div>
                            </div>
                            <!-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ -->
                            <div v-if="settingsSubTab === 'users'">
                                <div class="flex justify-between items-center mb-6"><h2 class="text-xl font-bold">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h2><button @click="showAddUserModal = true" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700"><i class="fas fa-plus mr-2"></i>–î–æ–±–∞–≤–∏—Ç—å</button></div>
                                <div class="bg-white border rounded-lg overflow-hidden">
                                    <table class="w-full"><thead class="bg-gray-50 border-b"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">–†–æ–ª—å</th><th class="px-6 py-3"></th></tr></thead>
                                        <tbody class="divide-y"><tr v-for="user in companyUsers" :key="user.id" class="hover:bg-gray-50"><td class="px-6 py-4"><div class="font-medium">{{ user.first_name }} {{ user.last_name }}</div><div class="text-sm text-gray-500">{{ user.email }}</div></td><td class="px-6 py-4">{{ user.role }}</td><td class="px-6 py-4 text-right"><button v-if="user.id !== currentUser.id" @click="deactivateUser(user.id)" class="text-red-500 hover:text-red-700 text-sm">–£–¥–∞–ª–∏—Ç—å</button></td></tr></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </main>
        </div>

        <!-- ========== –ú–û–î–ê–õ–ö–ò ========== -->
        
        <!-- –°–æ–∑–¥–∞–Ω–∏–µ –≤–∞–∫–∞–Ω—Å–∏–∏ -->
        <div v-if="showModal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
            <div class="bg-white p-6 rounded-lg shadow-xl w-96">
                <h2 class="text-xl font-bold mb-4">‚ú® –°–æ–∑–¥–∞—Ç—å –≤–∞–∫–∞–Ω—Å–∏—é</h2>
                <div class="mb-4"><label class="block text-sm font-bold mb-1">–î–æ–ª–∂–Ω–æ—Å—Ç—å</label><input v-model="newVacancy.title" type="text" class="w-full border p-2 rounded"></div>
                <div class="mb-4"><label class="block text-sm font-bold mb-1">–ù–∞–≤—ã–∫–∏</label><textarea v-model="newVacancy.requirements" class="w-full border p-2 rounded"></textarea></div>
                <div class="flex justify-end gap-2">
                    <button @click="showModal = false" class="text-gray-500 px-4 py-2 hover:bg-gray-100 rounded">–û—Ç–º–µ–Ω–∞</button>
                    <button @click="createVacancy" :disabled="loading" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 flex items-center"><span v-if="loading">AI...</span><span v-else>–°–æ–∑–¥–∞—Ç—å</span></button>
                </div>
            </div>
        </div>

        <!-- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
        <div v-if="showAddUserModal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
            <div class="bg-white p-6 rounded-lg shadow-xl w-96">
                <h2 class="text-xl font-bold mb-4">–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
                <div class="space-y-3">
                    <input v-model="newUser.first_name" placeholder="–ò–º—è" class="w-full border p-2 rounded">
                    <input v-model="newUser.last_name" placeholder="–§–∞–º–∏–ª–∏—è" class="w-full border p-2 rounded">
                    <input v-model="newUser.email" placeholder="Email" class="w-full border p-2 rounded">
                    <input v-model="newUser.password" placeholder="–ü–∞—Ä–æ–ª—å" class="w-full border p-2 rounded">
                    <select v-model="newUser.role" class="w-full border p-2 rounded"><option value="recruiter">–†–µ–∫—Ä—É—Ç–µ—Ä</option><option value="admin">–ê–¥–º–∏–Ω</option></select>
                </div>
                <div class="flex justify-end gap-2 mt-4">
                    <button @click="showAddUserModal = false" class="text-gray-500 px-4 py-2">–û—Ç–º–µ–Ω–∞</button>
                    <button @click="createUser" class="bg-green-600 text-white px-4 py-2 rounded">–î–æ–±–∞–≤–∏—Ç—å</button>
                </div>
            </div>
        </div>

        <!-- –ö–∞–Ω–±–∞–Ω –í–∞–∫–∞–Ω—Å–∏–∏ -->
        <div v-if="showVacancyDetail" class="fixed inset-0 bg-black bg-opacity-50 z-50 overflow-auto flex justify-center items-start pt-5 pb-5">
            <div class="bg-white w-full max-w-[95%] h-[90vh] rounded-lg shadow-xl flex flex-col">
                <div class="p-4 border-b flex justify-between items-center bg-gray-50 rounded-t-lg">
                    <div><h2 class="text-xl font-bold">{{ selectedVacancy.title }}</h2><p class="text-xs text-gray-500">–ö–∞–Ω–¥–∏–¥–∞—Ç–æ–≤: {{ selectedVacancy.candidates_count }}</p></div>
                    <button @click="closeVacancyDetail" class="text-gray-400 hover:text-gray-700 text-2xl">&times;</button>
                </div>
                <div class="flex-1 p-4 bg-gray-100 overflow-y-auto">
                    <div class="grid grid-cols-1 md:grid-cols-3 xl:grid-cols-6 gap-4 h-full">
                        <div v-for="status in statuses" :key="status.key" class="flex flex-col bg-gray-200 rounded-lg p-2 h-full min-h-[300px]">
                            <div class="flex justify-between items-center mb-2 px-2"><span class="font-bold text-gray-700 text-sm flex items-center truncate"><span class="w-2 h-2 rounded-full mr-2 flex-shrink-0" :class="status.color"></span>{{ status.label }}</span><span class="bg-white text-xs px-2 py-0.5 rounded-full text-gray-500 shadow-sm">{{ vacancyCandidatesByStatus(status.key).length }}</span></div>
                            <div class="column-body flex-1 space-y-2 pr-1 overflow-y-auto custom-scrollbar" :data-status="status.key">
                                <div v-for="cand in vacancyCandidatesByStatus(status.key)" :key="cand.id" :data-id="cand.id" @click.stop="openCandidateCard(cand.id)" class="bg-white p-3 rounded shadow-sm cursor-move hover:shadow-md border-l-4 transition relative group" :class="getScoreBorderColor(cand.ai_score)">
                                    <div class="flex justify-between items-start"><div class="font-bold text-sm text-gray-800 truncate pr-2">{{ cand.first_name }} {{ cand.last_name }}</div><div class="text-xs font-bold flex-shrink-0" :class="getTextColor(cand.ai_score)">{{ cand.ai_score }}%</div></div>
                                    <div class="text-xs text-gray-500 mt-1 truncate">@{{ cand.telegram_id }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ –ö–∞–Ω–¥–∏–¥–∞—Ç–∞ -->
        <div v-if="showCandidateCard" class="fixed inset-0 bg-black bg-opacity-50 z-50 overflow-auto flex justify-center items-start pt-5 pb-5">
            <div class="bg-white w-full max-w-5xl rounded-lg shadow-xl min-h-[80vh] flex flex-col">
                <div class="p-6 border-b flex justify-between items-start bg-gray-50 rounded-t-lg">
                    <div class="flex gap-5">
                        <div class="w-20 h-20 rounded-full bg-gradient-to-br from-blue-500 to-blue-700 flex items-center justify-center text-white text-3xl font-bold shadow-md">{{ candidateDetail.first_name?.[0] }}</div>
                        <div>
                            <h2 class="text-3xl font-bold text-gray-800">{{ candidateDetail.first_name }} {{ candidateDetail.last_name }}</h2>
                            <p class="text-blue-600 font-medium mt-1">{{ candidateDetail.vacancy_title }}</p>
                            <div class="flex gap-2 mt-3"><span class="px-3 py-1 rounded-full text-sm font-medium" :class="getStatusClass(candidateDetail.status)">{{ getStatusLabel(candidateDetail.status) }}</span></div>
                        </div>
                    </div>
                    <button @click="closeCandidateCard" class="text-gray-400 hover:text-gray-700 text-3xl">&times;</button>
                </div>
                <div class="flex-1 grid grid-cols-1 lg:grid-cols-3">
                    <div class="lg:col-span-2 p-6 border-r space-y-6">
                        <div class="bg-blue-50 p-5 rounded-lg border border-blue-100"><h3 class="font-bold text-blue-800 mb-2">ü§ñ AI –ú–Ω–µ–Ω–∏–µ</h3><p class="text-gray-700">{{ candidateDetail.ai_summary }}</p></div>
                        <div><h3 class="font-bold text-gray-800 mb-3">üìÑ –†–µ–∑—é–º–µ</h3><div class="bg-gray-50 p-4 rounded-lg border text-sm text-gray-700 whitespace-pre-wrap font-mono max-h-96 overflow-y-auto">{{ candidateDetail.resume_text }}</div></div>
                    </div>
                    <div class="p-6 bg-gray-50 space-y-6">
                        <div class="bg-white p-4 rounded-lg shadow-sm border"><h3 class="font-bold text-gray-800 mb-3">–î–µ–π—Å—Ç–≤–∏—è</h3><div class="flex flex-col gap-2"><button @click="changeStatusFromCard('interview')" class="w-full bg-green-500 text-white py-2 rounded hover:bg-green-600">–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å</button><button @click="changeStatusFromCard('rejected')" class="w-full bg-red-100 text-red-600 py-2 rounded hover:bg-red-200">–û—Ç–∫–∞–∑–∞—Ç—å</button></div></div>
                        <div class="bg-white p-4 rounded-lg shadow-sm border"><h3 class="font-bold text-gray-800 mb-3">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h3><div class="space-y-3 mb-4 max-h-60 overflow-y-auto"><div v-for="comm in candidateDetail.comments" :key="comm.id" class="bg-gray-50 p-2 rounded text-sm"><div class="font-bold text-xs text-gray-500">{{ comm.author_name }}</div><p>{{ comm.text }}</p></div></div><div class="flex gap-2"><input v-model="newComment" @keyup.enter="addComment" type="text" placeholder="–ó–∞–º–µ—Ç–∫–∞..." class="flex-1 border rounded px-2 py-1 text-sm"><button @click="addComment" class="bg-blue-600 text-white px-3 py-1 rounded text-sm">OK</button></div></div>
                        <div><h3 class="font-bold text-gray-500 text-xs uppercase mb-3">–ò—Å—Ç–æ—Ä–∏—è</h3><div class="space-y-4 border-l-2 border-gray-200 ml-2 pl-4"><div v-for="act in candidateDetail.activities" :key="act.id" class="relative"><div class="absolute -left-[21px] top-1 w-3 h-3 bg-gray-300 rounded-full border-2 border-white"></div><p class="text-sm text-gray-800">{{ act.description }}</p><p class="text-xs text-gray-400">{{ new Date(act.created_at).toLocaleString() }}</p></div></div></div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        const { createApp } = Vue

        createApp({
            data() {
                return {
                    apiUrl: 'http://127.0.0.1:8000',
                    isAuthenticated: false,
                    currentUser: null,
                    authToken: null,
                    authMode: 'login',
                    authForm: { email: '', password: '', first_name: '', last_name: '', company_name: '' },
                    authError: '',
                    currentTab: 'dashboard',
                    
                    // –î–∞–Ω–Ω—ã–µ
                    dashboardData: { active_vacancies: 0, candidates_in_work: 0, hired_this_month: 0, conversion_rate: 0, funnel_stats: {}, recent_activities: [], urgent_candidates: [] },
                    vacancies: [],
                    candidatesList: { items: [], total: 0, page: 1, pages: 1 },
                    filters: { search: '', status: '', vacancy_id: '' },
                    
                    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏
                    settingsSubTab: 'company',
                    companyProfile: {},
                    companyUsers: [],
                    showAddUserModal: false,
                    newUser: { first_name: '', last_name: '', email: '', password: '', role: 'recruiter' },
                    
                    // –ú–æ–¥–∞–ª–∫–∏
                    showModal: false,
                    showVacancyDetail: false,
                    showCandidateCard: false,
                    loading: false,
                    
                    newVacancy: { title: '', requirements: '' },
                    selectedVacancy: {},
                    vacancyCandidates: [],
                    candidateDetail: {},
                    newComment: '',
                    
                    statuses: [
                        { key: 'new', label: '–ù–æ–≤—ã–π', color: 'bg-blue-500' },
                        { key: 'screening', label: '–°–∫—Ä–∏–Ω–∏–Ω–≥', color: 'bg-purple-500' },
                        { key: 'interview', label: '–ò–Ω—Ç–µ—Ä–≤—å—é', color: 'bg-yellow-500' },
                        { key: 'offer', label: '–û—Ñ—Ñ–µ—Ä', color: 'bg-orange-500' },
                        { key: 'hired', label: '–ù–∞–Ω—è—Ç', color: 'bg-green-500' },
                        { key: 'rejected', label: '–û—Ç–∫–∞–∑', color: 'bg-red-500' }
                    ],
                    dashboardChart: null,
                    searchTimeout: null
                }
            },
            methods: {
                // --- AUTH ---
                checkAuth() {
                    const token = localStorage.getItem('hr_token');
                    const user = localStorage.getItem('hr_user');
                    if (token && user) {
                        this.authToken = token;
                        this.currentUser = JSON.parse(user);
                        this.isAuthenticated = true;
                        this.loadDashboard();
                        this.loadSettings(); // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ä–∞–∑—É
                    }
                },
                async login() {
                    try {
                        const res = await fetch(`${this.apiUrl}/auth/login`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email: this.authForm.email, password: this.authForm.password }) });
                        if (!res.ok) throw new Error((await res.json()).detail);
                        this.saveAuth(await res.json());
                    } catch (e) { this.authError = e.message; }
                },
                async register() {
                    try {
                        const res = await fetch(`${this.apiUrl}/auth/register`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(this.authForm) });
                        if (!res.ok) throw new Error((await res.json()).detail);
                        this.saveAuth(await res.json());
                    } catch (e) { this.authError = e.message; }
                },
                saveAuth(data) {
                    this.authToken = data.access_token;
                    this.currentUser = data.user;
                    this.isAuthenticated = true;
                    localStorage.setItem('hr_token', data.access_token);
                    localStorage.setItem('hr_user', JSON.stringify(data.user));
                    this.loadDashboard();
                    this.loadSettings();
                },
                logout() {
                    this.isAuthenticated = false;
                    this.authToken = null;
                    localStorage.removeItem('hr_token');
                },
                // --- API WRAPPER ---
                async apiFetch(url, options = {}) {
                    const headers = { 'Content-Type': 'application/json', ...(options.headers || {}) };
                    if (this.authToken) headers['Authorization'] = `Bearer ${this.authToken}`;
                    const res = await fetch(url, { ...options, headers });
                    if (res.status === 401) this.logout();
                    return res;
                },
                // --- DATA LOADING ---
                async loadDashboard() {
                    try {
                        const res = await this.apiFetch(`${this.apiUrl}/dashboard/stats`);
                        this.dashboardData = await res.json();
                        this.$nextTick(() => this.renderDashboardChart());
                    } catch (e) {}
                },
                async fetchData() {
                    try {
                        const res = await this.apiFetch(`${this.apiUrl}/vacancies/`);
                        this.vacancies = await res.json();
                    } catch (e) {}
                },
                async loadCandidates() {
                    try {
                        const params = new URLSearchParams({ page: this.candidatesList.page, per_page: 10, search: this.filters.search, status: this.filters.status, vacancy_id: this.filters.vacancy_id });
                        if (!this.filters.search) params.delete('search');
                        if (!this.filters.status) params.delete('status');
                        if (!this.filters.vacancy_id) params.delete('vacancy_id');
                        const res = await this.apiFetch(`${this.apiUrl}/candidates/search?${params}`);
                        this.candidatesList = await res.json();
                    } catch (e) {}
                },
                // --- SETTINGS ---
                async loadSettings() {
                    this.loadCompanyProfile();
                },
                async loadCompanyProfile() {
                    const res = await this.apiFetch(`${this.apiUrl}/settings/company`);
                    this.companyProfile = await res.json();
                },
                async saveCompanyProfile() {
                    await this.apiFetch(`${this.apiUrl}/settings/company`, { method: 'PATCH', body: JSON.stringify(this.companyProfile) });
                    alert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!');
                },
                async loadUsers() {
                    const res = await this.apiFetch(`${this.apiUrl}/settings/users`);
                    this.companyUsers = await res.json();
                },
                async createUser() {
                    await this.apiFetch(`${this.apiUrl}/settings/users`, { method: 'POST', body: JSON.stringify(this.newUser) });
                    this.showAddUserModal = false;
                    this.loadUsers();
                },
                async deactivateUser(id) {
                    if(!confirm('–£–¥–∞–ª–∏—Ç—å?')) return;
                    await this.apiFetch(`${this.apiUrl}/settings/users/${id}`, { method: 'DELETE' });
                    this.loadUsers();
                },
                // --- ACTIONS ---
                async createVacancy() {
                    if (!this.newVacancy.title) return;
                    this.loading = true;
                    try {
                        await this.apiFetch(`${this.apiUrl}/vacancies/generate`, { method: 'POST', body: JSON.stringify({ title: this.newVacancy.title, requirements: this.newVacancy.requirements }) });
                        this.showModal = false;
                        this.newVacancy = { title: '', requirements: '' };
                        this.fetchData();
                    } finally { this.loading = false; }
                },
                async openVacancy(id) {
                    try {
                        const resDetail = await this.apiFetch(`${this.apiUrl}/vacancies/${id}`);
                        this.selectedVacancy = await resDetail.json();
                        const resCands = await this.apiFetch(`${this.apiUrl}/vacancies/${id}/candidates`);
                        this.vacancyCandidates = await resCands.json();
                        this.showVacancyDetail = true;
                        this.$nextTick(() => this.initSortable());
                    } catch (e) {}
                },
                closeVacancyDetail() { this.showVacancyDetail = false; },
                async openCandidateCard(id) {
                    try {
                        const res = await this.apiFetch(`${this.apiUrl}/candidates/${id}/detail`);
                        this.candidateDetail = await res.json();
                        this.showCandidateCard = true;
                    } catch (e) {}
                },
                closeCandidateCard() { this.showCandidateCard = false; this.candidateDetail = {}; },
                async addComment() {
                    if (!this.newComment.trim()) return;
                    await this.apiFetch(`${this.apiUrl}/candidates/${this.candidateDetail.id}/comments`, { method: 'POST', body: JSON.stringify({ text: this.newComment, author_name: this.currentUser.first_name }) });
                    this.newComment = '';
                    this.openCandidateCard(this.candidateDetail.id);
                },
                async changeStatusFromCard(newStatus) {
                    await this.updateStatus(this.candidateDetail.id, newStatus);
                    this.openCandidateCard(this.candidateDetail.id);
                    this.loadCandidates();
                },
                async updateStatus(id, newStatus) {
                    await this.apiFetch(`${this.apiUrl}/candidates/${id}`, { method: 'PATCH', body: JSON.stringify({ status: newStatus }) });
                },
                // --- HELPERS ---
                vacancyCandidatesByStatus(status) { return this.vacancyCandidates.filter(c => c.status === status); },
                initSortable() {
                    document.querySelectorAll('.column-body').forEach(col => {
                        new Sortable(col, { group: 'kanban', animation: 150, ghostClass: 'opacity-50', onEnd: (evt) => { if (evt.from === evt.to) return; this.updateStatus(evt.item.dataset.id, evt.to.dataset.status); } });
                    });
                },
                renderDashboardChart() {
                    const ctx = document.getElementById('dashboardChart');
                    if (!ctx) return;
                    if (this.dashboardChart) this.dashboardChart.destroy();
                    const stats = this.dashboardData.funnel_stats;
                    this.dashboardChart = new Chart(ctx, { type: 'bar', data: { labels: ['–ù–æ–≤—ã–π', '–°–∫—Ä–∏–Ω–∏–Ω–≥', '–ò–Ω—Ç–µ—Ä–≤—å—é', '–û—Ñ—Ñ–µ—Ä', '–ù–∞–Ω—è—Ç', '–û—Ç–∫–∞–∑'], datasets: [{ label: '–ö–∞–Ω–¥–∏–¥–∞—Ç—ã', data: [stats.new||0, stats.screening||0, stats.interview||0, stats.offer||0, stats.hired||0, stats.rejected||0], backgroundColor: ['#3B82F6', '#A855F7', '#EAB308', '#F97316', '#22C55E', '#EF4444'], borderRadius: 6 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } } });
                },
                debouncedSearch() { clearTimeout(this.searchTimeout); this.searchTimeout = setTimeout(() => { this.candidatesList.page = 1; this.loadCandidates(); }, 500); },
                resetFilters() { this.filters = { search: '', status: '', vacancy_id: '' }; this.loadCandidates(); },
                getStatusClass(status) { const map = { 'new': 'bg-blue-100 text-blue-800', 'screening': 'bg-purple-100 text-purple-800', 'interview': 'bg-yellow-100 text-yellow-800', 'offer': 'bg-orange-100 text-orange-800', 'hired': 'bg-green-100 text-green-800', 'rejected': 'bg-red-100 text-red-800' }; return map[status] || 'bg-gray-100'; },
                getStatusLabel(status) { const map = { 'new': '–ù–æ–≤—ã–π', 'screening': '–°–∫—Ä–∏–Ω–∏–Ω–≥', 'interview': '–ò–Ω—Ç–µ—Ä–≤—å—é', 'offer': '–û—Ñ—Ñ–µ—Ä', 'hired': '–ù–∞–Ω—è—Ç', 'rejected': '–û—Ç–∫–∞–∑' }; return map[status] || status; },
                getScoreBgColor(score) { if (score >= 80) return 'bg-green-100 text-green-800 border-green-200'; if (score >= 50) return 'bg-yellow-100 text-yellow-800 border-yellow-200'; return 'bg-red-100 text-red-800 border-red-200'; },
                getScoreBorderColor(score) { if (score >= 80) return 'border-green-500'; if (score >= 50) return 'border-yellow-400'; return 'border-red-500'; },
                getTextColor(score) { if (score >= 80) return 'text-green-600'; if (score >= 50) return 'text-yellow-600'; return 'text-red-600'; }
            },
            mounted() { this.checkAuth(); }
        }).mount('#app')
    </script>
</body>
</html>